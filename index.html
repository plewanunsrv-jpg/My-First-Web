PE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting & Task Tracker (Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .modal-active { overflow: hidden; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        /* Loading Overlay */
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 100; items-center; justify-content: center; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
    <div id="loading-overlay" class="flex flex-col">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <p class="mt-4 font-bold text-blue-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Meeting & Task Dashboard</h1>
                <p class="text-gray-500 mt-1">‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô Google Sheets</p>
            </div>
            <button onclick="openModal()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl shadow-lg transition-all transform active:scale-95">
                <i data-lucide="plus-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏°‡πà
            </button>
        </div>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8" id="stats-container"></div>

        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row gap-4">
            <div class="relative flex-1">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 size-5"></i>
                <input type="text" id="search-input" oninput="renderDashboard()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠, Part No, ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö..." class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-xl outline-none">
            </div>
            <div class="flex items-center gap-2 min-w-[200px]">
                <select id="status-filter" onchange="renderDashboard()" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl outline-none font-medium">
                    <option value="Active">‚ö° ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ (Active)</option>
                    <option value="All">üìÇ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="Normal">üîµ ‡∏õ‡∏Å‡∏ï‡∏¥</option>
                    <option value="Warning">üü° ‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î</option>
                    <option value="Overdue">üî¥ ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</option>
                    <option value="Completed">üü¢ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                </select>
            </div>
        </div>

        <div id="task-list" class="space-y-4"></div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/60 hidden z-50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <h2 class="text-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏°‡πà</h2>
                <button onclick="closeModal()" class="p-2 hover:bg-gray-100 rounded-full text-gray-400"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll flex-1">
                <div class="bg-blue-50 border border-blue-100 p-5 rounded-2xl mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <input type="date" id="m-date" class="w-full p-2.5 border border-blue-200 rounded-xl outline-none">
                        <input type="text" id="m-location" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà / ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á" class="w-full p-2.5 border border-blue-200 rounded-xl outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-5 space-y-4">
                        <input type="text" id="t-topic" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á..." class="w-full p-2.5 border border-gray-200 rounded-xl outline-none">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="t-partno" placeholder="Part No" class="w-full p-2.5 border border-gray-200 rounded-xl outline-none">
                            <input type="text" id="t-partname" placeholder="Part Name" class="w-full p-2.5 border border-gray-200 rounded-xl outline-none">
                        </div>
                        <input type="text" id="t-res" placeholder="‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö" class="w-full p-2.5 border border-gray-200 rounded-xl outline-none">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="date" id="t-start" class="w-full p-2.5 border border-gray-200 rounded-xl outline-none">
                            <input type="date" id="t-due" class="w-full p-2.5 border border-gray-200 rounded-xl outline-none">
                        </div>
                        <button onclick="addTempTask()" class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold hover:bg-black transition-all">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                    </div>
                    <div class="lg:col-span-7">
                        <div class="bg-gray-50 border border-dashed border-gray-300 rounded-2xl min-h-[300px] overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr><th class="p-3 text-left">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th class="p-3 text-left">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th><th class="p-3">‡∏•‡∏ö</th></tr>
                                </thead>
                                <tbody id="temp-list-body" class="divide-y divide-gray-200"></tbody>
                            </table>
                            <div id="temp-empty" class="flex flex-col items-center justify-center p-12 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-6 py-2.5 border border-gray-300 rounded-xl">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveAllToStorage()" id="save-btn" disabled class="px-8 py-2.5 bg-blue-600 text-white rounded-xl font-bold disabled:bg-gray-300">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxi7-9UEwkP7Ht6KPIROaY3OZVm-bbGHciLigIDI-910ils-z4avLCynFexhN4IR3Ih/exec';
        let meetings = [];
        let tempTasks = [];

        async function loadData() {
            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL);
                meetings = await response.json();
                renderDashboard();
            } catch (e) { console.error("Load failed", e); }
            showLoading(false);
        }

        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        function calculateDaysDiff(d1, d2) {
            const date1 = new Date(d1);
            const date2 = new Date(d2);
            date1.setHours(0,0,0,0); date2.setHours(0,0,0,0);
            return Math.ceil((date2 - date1) / (1000 * 60 * 60 * 24));
        }

        function getTaskStatus(item) {
            if (item.status === 'Completed') return 'Completed';
            const daysLeft = calculateDaysDiff(new Date(), item.dueDate);
            if (daysLeft < 0) return 'Overdue';
            if (daysLeft <= 7) return 'Warning';
            return 'Normal';
        }

        function openModal() {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('m-date').value = new Date().toISOString().split('T')[0];
            tempTasks = []; renderTempTasks(); lucide.createIcons();
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function addTempTask() {
            const topic = document.getElementById('t-topic').value;
            const res = document.getElementById('t-res').value;
            const start = document.getElementById('t-start').value;
            const due = document.getElementById('t-due').value;
            if (!topic || !res || !start || !due) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            tempTasks.push({
                tempId: Date.now(), topic, responsible: res, startDate: start, dueDate: due,
                partNo: document.getElementById('t-partno').value, partName: document.getElementById('t-partname').value
            });
            ['t-topic', 't-partno', 't-partname', 't-res', 't-start', 't-due'].forEach(id => document.getElementById(id).value = '');
            renderTempTasks();
        }

        function renderTempTasks() {
            const body = document.getElementById('temp-list-body');
            const saveBtn = document.getElementById('save-btn');
            document.getElementById('temp-empty').classList.toggle('hidden', tempTasks.length > 0);
            saveBtn.disabled = tempTasks.length === 0;
            body.innerHTML = tempTasks.map(t => `
                <tr class="bg-white">
                    <td class="p-3"><b>${t.topic}</b></td>
                    <td class="p-3">${t.responsible}</td>
                    <td class="p-3 text-center"><button onclick="tempTasks = tempTasks.filter(x => x.tempId !== ${t.tempId}); renderTempTasks();" class="text-red-400">‡∏•‡∏ö</button></td>
                </tr>
            `).join('');
        }

        async function saveAllToStorage() {
            const mDate = document.getElementById('m-date').value;
            const mLocation = document.getElementById('m-location').value;
            if (!mDate || !mLocation) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°");

            showLoading(true);
            const newRecords = tempTasks.map(t => ({
                id: Date.now() + Math.random(), meetingDate: mDate, location: mLocation,
                topic: t.topic, partNo: t.partNo, partName: t.partName, responsible: t.responsible,
                startDate: t.startDate, dueDate: t.dueDate, status: 'Pending', completionDate: ''
            }));

            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'add', records: newRecords }) });
            closeModal();
            await loadData();
        }

        async function toggleComplete(id) {
            showLoading(true);
            const item = meetings.find(m => m.id == id);
            const isDone = item.status === 'Completed';
            await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'update', id, status: isDone ? 'Pending' : 'Completed',
                    completionDate: isDone ? '' : new Date().toISOString().split('T')[0]
                })
            });
            await loadData();
        }

        async function deleteRecord(id) {
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) return;
            showLoading(true);
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id }) });
            await loadData();
        }

        // ‡∏™‡πà‡∏ß‡∏ô RenderDashboard ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å meetings ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å loadData()
        function renderDashboard() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            const filterValue = document.getElementById('status-filter').value;
            const container = document.getElementById('task-list');

            const filtered = meetings.filter(m => {
                const status = getTaskStatus(m);
                const matchesSearch = String(m.topic).toLowerCase().includes(searchText) || 
                                     String(m.responsible).toLowerCase().includes(searchText);
                let matchesStatus = (filterValue === 'Active') ? status !== 'Completed' : (filterValue === 'All' || status === filterValue);
                return matchesSearch && matchesStatus;
            });

            // (‡∏™‡πà‡∏ß‡∏ô HTML Template ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô container.innerHTML ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö)
            container.innerHTML = filtered.length === 0 ? '<div class="text-center py-20 bg-white rounded-3xl border border-dashed border-gray-300 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>' : 
            filtered.map(m => {
                const status = getTaskStatus(m);
                const isDone = m.status === 'Completed';
                const daysRemaining = calculateDaysDiff(new Date(), m.dueDate);
                return `
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 flex flex-col md:flex-row gap-6 relative overflow-hidden group">
                        <div class="absolute left-0 top-0 bottom-0 w-1.5 ${isDone ? 'bg-green-500' : status === 'Overdue' ? 'bg-red-500' : 'bg-blue-500'}"></div>
                        <div class="flex-1">
                            <div class="text-[11px] text-gray-400 font-bold uppercase mb-1">${new Date(m.meetingDate).toLocaleDateString('th-TH')} | ${m.location}</div>
                            <h3 class="text-lg font-bold text-gray-800">${m.topic}</h3>
                            <div class="text-xs text-gray-500 mt-1">Part: ${m.partNo || '-'} | ${m.partName || '-'}</div>
                        </div>
                        <div class="flex-1 md:border-l md:pl-6">
                            <p class="text-[10px] text-gray-400 uppercase font-bold">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
                            <p class="text-sm font-bold">${m.responsible}</p>
                            <div class="text-[11px] text-gray-400 mt-2">‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${new Date(m.dueDate).toLocaleDateString('th-TH')}</div>
                        </div>
                        <div class="flex flex-col items-end justify-between min-w-[150px] md:border-l md:pl-6">
                            <div class="flex gap-2">
                                <span class="px-2 py-1 rounded text-[10px] font-black border ${isDone ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">${status}</span>
                                <button onclick="deleteRecord('${m.id}')" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="size-4"></i></button>
                            </div>
                            <button onclick="toggleComplete('${m.id}')" class="mt-4 w-full py-2 px-4 rounded-xl text-xs font-bold border ${isDone ? 'bg-gray-100' : 'bg-green-600 text-white'}">
                                ${isDone ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : '‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'}
                            </button>
                        </div>
                    </div>`;
            }).join('');
            lucide.createIcons();
        }

        window.onload = loadData;
    </script>
</body>
</html>
