<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Meeting Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .modal-active { overflow: hidden; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Meeting Dashboard</h1>
                <p class="text-gray-500">ข้อมูลซิงค์จาก Google Sheets (เห็นเหมือนกันทุกคน)</p>
            </div>
            <div class="flex gap-2">
                <button onclick="loadDataFromSheet()" class="p-3 bg-white border rounded-xl hover:bg-gray-50 shadow-sm transition-all">
                    <i data-lucide="refresh-cw" id="refresh-icon"></i>
                </button>
                <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-2 transition-all">
                    <i data-lucide="plus-circle"></i> บันทึกงานใหม่
                </button>
            </div>
        </div>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8" id="stats-container"></div>

        <div id="task-list" class="space-y-4">
            <div class="text-center py-20 text-gray-400">กำลังโหลดข้อมูล...</div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/60 hidden z-50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">บันทึกการประชุมใหม่</h2>
                <button onclick="closeModal()" class="text-gray-400"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div class="bg-blue-50 p-5 rounded-2xl mb-6 grid grid-cols-2 gap-4">
                    <input type="date" id="m-date" class="p-2.5 border rounded-xl">
                    <input type="text" id="m-location" placeholder="สถานที่ประชุม" class="p-2.5 border rounded-xl">
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-4 p-4 border rounded-2xl">
                        <input type="text" id="t-topic" placeholder="หัวข้อเรื่อง" class="w-full p-2.5 border rounded-xl">
                        <input type="text" id="t-res" placeholder="ผู้รับผิดชอบ" class="w-full p-2.5 border rounded-xl">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="date" id="t-start" class="p-2.5 border rounded-xl">
                            <input type="date" id="t-due" class="p-2.5 border rounded-xl">
                        </div>
                        <button onclick="addTempTask()" class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold">+ เพิ่มรายการ</button>
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4 overflow-y-auto max-h-[300px]">
                        <table class="w-full text-sm" id="temp-table">
                            <tbody id="temp-list-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end gap-3">
                <button onclick="closeModal()" class="px-6 py-2 border rounded-xl">ยกเลิก</button>
                <button onclick="saveAllToStorage()" id="save-btn" disabled class="px-8 py-2 bg-blue-600 text-white rounded-xl font-bold">บันทึกทั้งหมดลง Sheet</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzlV4JlyhiGARQSAaUHzwXxH6F4vGe9288JzSoAus-2Octta8nVW90y_qnoj2nKpk0I/exec';
        let meetings = [];
        let tempTasks = [];

        async function loadDataFromSheet() {
            const container = document.getElementById('task-list');
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('animate-spin');
            
            try {
                const response = await fetch(SCRIPT_URL);
                meetings = await response.json();
                renderDashboard();
            } catch (e) {
                container.innerHTML = '<div class="text-center py-20 text-red-500">โหลดข้อมูลไม่สำเร็จ กรุณาตรวจสอบการตั้งค่า Deployment</div>';
            } finally {
                icon.classList.remove('animate-spin');
            }
        }

        function renderDashboard() {
            const container = document.getElementById('task-list');
            const statsContainer = document.getElementById('stats-container');
            
            if (meetings.length === 0) {
                container.innerHTML = '<div class="text-center py-20 text-gray-400">ไม่มีข้อมูลใน Google Sheets</div>';
                return;
            }

            container.innerHTML = meetings.map(m => `
                <div class="bg-white rounded-2xl border p-5 flex flex-col md:flex-row gap-6 border-l-8 ${m.status === 'Completed' ? 'border-l-green-500' : 'border-l-blue-500'}">
                    <div class="flex-1">
                        <p class="text-[10px] text-gray-400 font-bold">${m.meetingDate} | ${m.location}</p>
                        <h3 class="text-lg font-bold">${m.topic}</h3>
                        <p class="text-xs text-gray-500">Part: ${m.partNo || '-'} | ${m.partName || '-'}</p>
                    </div>
                    <div class="flex-1 md:border-l md:pl-6">
                        <p class="text-[10px] text-gray-400 font-bold uppercase">ผู้รับผิดชอบ</p>
                        <p class="font-bold text-gray-700">${m.responsible}</p>
                        <p class="text-xs text-gray-500 italic">กำหนดส่ง: ${m.dueDate}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="px-3 py-1 rounded-lg text-[10px] font-bold border ${m.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                            ${m.status === 'Completed' ? 'เสร็จสิ้น' : 'รอดำเนินการ'}
                        </span>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        async function saveAllToStorage() {
            const btn = document.getElementById('save-btn');
            const payload = tempTasks.map(t => ({
                meetingDate: document.getElementById('m-date').value,
                location: document.getElementById('m-location').value,
                topic: t.topic,
                partNo: '', partName: '',
                responsible: t.responsible,
                startDate: t.startDate,
                dueDate: t.dueDate,
                status: 'Pending',
                completionDate: ''
            }));

            btn.disabled = true;
            btn.innerText = "กำลังบันทึก...";

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("บันทึกสำเร็จ!");
                closeModal();
                loadDataFromSheet();
            } catch (e) {
                alert("เกิดข้อผิดพลาด");
            } finally {
                btn.disabled = false;
                btn.innerText = "บันทึกทั้งหมดลง Sheet";
            }
        }

        function openModal() { 
            document.getElementById('modal').classList.remove('hidden'); 
            document.getElementById('m-date').value = new Date().toISOString().split('T')[0];
            tempTasks = [];
            renderTemp();
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        function addTempTask() {
            tempTasks.push({
                topic: document.getElementById('t-topic').value,
                responsible: document.getElementById('t-res').value,
                startDate: document.getElementById('t-start').value,
                dueDate: document.getElementById('t-due').value
            });
            renderTemp();
        }
        function renderTemp() {
            document.getElementById('temp-list-body').innerHTML = tempTasks.map(t => `<tr><td>${t.topic}</td><td>${t.responsible}</td></tr>`).join('');
            document.getElementById('save-btn').disabled = tempTasks.length === 0;
        }

        window.onload = loadDataFromSheet;
    </script>
</body>
</html>
