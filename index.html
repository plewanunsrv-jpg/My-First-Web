<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Action Tracker</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // ประกาศ Icons จาก Library
        const { Plus, Trash2, CheckCircle, Clock, AlertTriangle, Calendar: CalendarIcon, Search, Save, X: XIcon, Filter: FilterIcon, ListPlus, User } = lucide;

        // URL API ของคุณ
        const API_URL = "https://script.google.com/macros/s/AKfycbz1u9m2ChAxblJAMz7T3z53rKuEgSsT5jV3U0FZJK0y1mm-9JX8hd5-khx5LRUO89KF/exec";

        const App = () => {
            const [tasks, setTasks] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [filterText, setFilterText] = useState("");
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [pendingTasks, setPendingTasks] = useState([]);
            
            const [meetingInfo, setMeetingInfo] = useState({
                topic: "",
                date: new Date().toISOString().split('T')[0]
            });

            const [currentTask, setCurrentTask] = useState({
                task: "",
                assignee: "",
                startDate: new Date().toISOString().split('T')[0],
                dueDate: ""
            });

            // ดึงข้อมูลจาก Sheets
            const fetchTasks = async () => {
                setIsLoading(true);
                try {
                    const response = await fetch(API_URL);
                    const data = await response.json();
                    setTasks(data);
                } catch (error) {
                    console.error("Fetch error:", error);
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => { fetchTasks(); }, []);

            // บันทึกข้อมูลลง Sheets
            const handleSaveAll = async () => {
                if (pendingTasks.length === 0) return;
                setIsLoading(true);
                try {
                    const formData = new URLSearchParams();
                    formData.append('data', JSON.stringify(pendingTasks));

                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData.toString()
                    });
                    
                    setTimeout(() => {
                        fetchTasks();
                        setIsModalOpen(false);
                        setPendingTasks([]);
                        setMeetingInfo({ topic: "", date: new Date().toISOString().split('T')[0] });
                    }, 1500);
                } catch (error) {
                    alert("บันทึกไม่สำเร็จ");
                    setIsLoading(false);
                }
            };

            const addPendingTask = () => {
                if (!currentTask.task || !currentTask.dueDate) return;
                const newItem = { id: Date.now(), meetingTopic: meetingInfo.topic, meetingDate: meetingInfo.date, ...currentTask, isCompleted: false };
                setPendingTasks([...pendingTasks, newItem]);
                setCurrentTask({ task: "", assignee: "", startDate: new Date().toISOString().split('T')[0], dueDate: "" });
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-8">
                    <div className="max-w-7xl mx-auto space-y-6">
                        <header className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-2">
                                <CalendarIcon className="text-blue-600" /> Tracker
                            </h1>
                            <button onClick={() => setIsModalOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-md">
                                <Plus size={20} /> บันทึกข้อมูล
                            </button>
                        </header>

                        {/* ตารางแสดงผล */}
                        <div className="bg-white rounded-xl shadow-sm overflow-hidden border">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 border-b font-semibold">
                                    <tr>
                                        <th className="p-4">งานที่ต้องทำ</th>
                                        <th className="p-4">ผู้รับผิดชอบ</th>
                                        <th className="p-4 text-center">กำหนดส่ง</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {isLoading ? (
                                        <tr><td colSpan="3" className="p-10 text-center text-gray-500">กำลังดึงข้อมูลจาก Google Sheets...</td></tr>
                                    ) : tasks.length > 0 ? (
                                        tasks.map(item => (
                                            <tr key={item.id} className="hover:bg-gray-50 transition">
                                                <td className="p-4">
                                                    <div className="font-bold text-gray-800">{item.task}</div>
                                                    <div className="text-xs text-blue-600">{item.meetingTopic}</div>
                                                </td>
                                                <td className="p-4 text-sm text-gray-600">{item.assignee}</td>
                                                <td className="p-4 text-center text-sm font-medium">{item.dueDate}</td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr><td colSpan="3" className="p-10 text-center text-gray-400">ยังไม่มีข้อมูลงาน</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>

                        {/* Modal บันทึกข้อมูล */}
                        {isModalOpen && (
                            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-xl max-w-2xl w-full p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-bold flex items-center gap-2"><Plus className="text-blue-600"/> บันทึกงานใหม่</h2>
                                        <button onClick={() => setIsModalOpen(false)}><XIcon className="text-gray-400"/></button>
                                    </div>
                                    
                                    <div className="bg-blue-50 p-4 rounded-lg mb-6 grid grid-cols-2 gap-4">
                                        <div className="col-span-2">
                                            <label className="text-xs font-bold text-gray-500">หัวข้อการประชุม</label>
                                            <input type="text" value={meetingInfo.topic} onChange={(e) => setMeetingInfo({...meetingInfo, topic: e.target.value})} className="w-full p-2 border rounded mt-1 outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุหัวข้อประชุม..."/>
                                        </div>
                                    </div>

                                    <div className="space-y-4 border-t pt-4">
                                        <input type="text" placeholder="รายละเอียดงาน..." value={currentTask.task} onChange={(e) => setCurrentTask({...currentTask, task: e.target.value})} className="w-full p-2 border rounded"/>
                                        <input type="text" placeholder="ชื่อผู้รับผิดชอบ" value={currentTask.assignee} onChange={(e) => setCurrentTask({...currentTask, assignee: e.target.value})} className="w-full p-2 border rounded"/>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-xs font-bold text-gray-500">วันส่ง (Due)</label>
                                                <input type="date" value={currentTask.dueDate} onChange={(e) => setCurrentTask({...currentTask, dueDate: e.target.value})} className="w-full p-2 border rounded"/>
                                            </div>
                                        </div>
                                        <button onClick={addPendingTask} className="w-full bg-gray-800 text-white p-2 rounded hover:bg-black transition">เพิ่มลงรายการ ({pendingTasks.length})</button>
                                    </div>

                                    <div className="mt-6 border-t pt-4 flex justify-end gap-3">
                                        <button onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-gray-500">ยกเลิก</button>
                                        <button onClick={handleSaveAll} disabled={pendingTasks.length === 0} className="bg-blue-600 text-white px-8 py-2 rounded-lg shadow-lg disabled:opacity-50">บันทึกทั้งหมดลง Sheet</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
